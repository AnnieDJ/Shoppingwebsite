{% extends "base.html" %} {% block title %}Today's Checklist{%
endblock %} {% block content %}
<div class="container-fluid">
  <h2>Today's Rental Checklist - {{ store_name }} Store</h2>
    <h3 style="font-weight: bold; padding: 10px 0;">Date: {{today}}</h3>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Rental ID</th>
        <th>Customer Name</th>
        <th>Equipment Name</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>ID Verified</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for booking in bookings %}

      <tr>
        <td>{{ booking.rental_id }}</td>
        <td>{{ booking.first_name }} {{ booking.family_name }}</td>
        <td>{{ booking.equipment_name }}</td>
        <td>{{ booking.start_date }}</td>
        <td>{{ booking.end_date }}</td>
        <td>
          <button
            type="button"
            class="btn btn-success"
            id="btn-check-{{ booking.rental_id }}"
            onclick= "toggleIDVerification({{ booking.rental_id }}, true)"
            {% if booking.id_verified %} style="display: none;" {% endif %}
          >
            <i class="fa fa-square" aria-hidden="true"></i>
          </button>

          <button
            type="button"
            class="btn btn-success"
            id="btn-uncheck-{{ booking.rental_id }}"
            onclick="toggleIDVerification({{ booking.rental_id }}, false)"
            {% if not booking.id_verified %} style="display: none;" {% endif %}
          >
            <i class="fa fa-check" aria-hidden="true"></i>
          </button>
        </td>

<td id="status-{{ booking.rental_id }}">{{ booking.checkout_status }}</td>

        <td id="action-buttons-{{ booking.rental_id }}">
          <button
            type="button"
            class="btn btn-primary btn-sm d-block w-100 mb-2"
            id="checkout-btn-{{ booking.rental_id }}"
            onclick="updateStatus({{ booking.rental_id }}, 'Completed')"
            {{ 'disabled' if not booking.id_verified }}
          >
            Ready to Checkout
          </button>
          <button
            type="button"
            class="btn btn-warning btn-sm d-block w-100 mb-2"
            onclick="updateStatus({{ booking.rental_id }}, 'Pending')"
          >
            Back to Pending
          </button>
          <button
            type="button"
            class="btn btn-danger btn-sm d-block w-100 mb-2"
            onclick="updateStatus({{ booking.rental_id }}, 'Canceled')"
          >
            Job Cancelled
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<script>

function toggleIDVerification(rentalId, shouldVerify) {
    fetch('{{ url_for('staff.verify_id') }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `rental_id=${rentalId}&id_verified=${shouldVerify}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('btn-check-' + rentalId).style.display = shouldVerify ? 'none' : 'block';
            document.getElementById('btn-uncheck-' + rentalId).style.display = shouldVerify ? 'block' : 'none';
            document.getElementById('checkout-btn-' + rentalId).disabled = !shouldVerify;

        } else {
            throw new Error(data.message || 'An unknown error occurred.');
        }
    })
    .catch(error => {
        console.error('Error verifying ID:', error);
        alert('Failed to verify ID: ' + error.message);
    });
}


  function updateStatus(rentalId, newStatus) {
      var form = new FormData();
      form.append('rental_id', rentalId);
      form.append('new_status', newStatus);

      fetch('{{ url_for('staff.update_rental_status') }}', {
          method: 'POST',
          body: form
      })
      .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();  // This will fail if the response is not JSON
    })
      .then(data => {
          if (data.success) {
              document.getElementById('status-' + rentalId).textContent = newStatus;
              var actionButtons = document.getElementById('action-buttons-' + rentalId);
              actionButtons.style.display = (newStatus === 'Completed' ? 'none' : 'block');
              alert('Status updated to ' + newStatus);
          } else {
              throw new Error(data.error || 'Unknown error occurred');
          }
      })
      .catch(error => {
          console.error('Error updating status:', error);
          alert('Failed to update status: ' + error.message);
      });
  }

</script>

{% endblock %}
