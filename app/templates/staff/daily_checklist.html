{% extends "sidebar_layout.html" %} {% block title %}Today's Checklist{%
endblock %} {% block main_content %}
<div class="container-fluid">
  <h2>Today's Rental Checklist</h2>
    <h3 style="font-weight: bold; padding: 10px 0;">Date: {{today}}</h3>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Rental ID</th>
        <th>User Name</th>
        <th>Equipment Name</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>Checkout Status</th>
        <th>ID Verified</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for booking in bookings %}

      <tr>
        <td>{{ booking.rental_id }}</td>
        <td>{{ booking.username }}</td>
        <td>{{ booking.equipment_name }}</td>
        <td>{{ booking.start_date }}</td>
        <td>{{ booking.end_date }}</td>
        <td id="status-{{ booking.rental_id }}">{{ booking.status }}</td>
        <td>
          <button
            type="button"
            class="btn btn-success"
            id="btn-check-{{ booking.rental_id }}"
            onclick="toggleIDVerification({{ booking.rental_id }}, true)"
            {% if booking.id_verified %} style="display: none;" {% endif %}
          >
            <i class="fa fa-check" aria-hidden="true"></i>
          </button>
          <!-- X Button -->
          <button
            type="button"
            class="btn btn-danger"
            id="btn-uncheck-{{ booking.rental_id }}"
            onclick="toggleIDVerification({{ booking.rental_id }}, false)"
            {% if not booking.id_verified %} style="display: none;" {% endif %}
          >
            <i class="fa fa-times" aria-hidden="true"></i>
          </button>
        </td>

        <td id="action-buttons-{{ booking.rental_id }}">
          <button
            type="button"
            class="btn btn-primary btn-sm d-block w-100 mb-2"
            onclick="updateStatus({{ booking.rental_id }}, 'Completed')"
          >
            Ready to Checkout
          </button>
          <button
            type="button"
            class="btn btn-warning btn-sm d-block w-100 mb-2"
            onclick="updateStatus({{ booking.rental_id }}, 'Pending')"
          >
            Back to Pending
          </button>
          <button
            type="button"
            class="btn btn-danger btn-sm d-block w-100 mb-2"
            onclick="updateStatus({{ booking.rental_id }}, 'Canceled')"
          >
            Job Cancelled
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<script>
  function updateStatus(rentalId, newStatus) {
      var form = new FormData();
      form.append('rental_id', rentalId);
      form.append('new_status', newStatus);

      fetch('{{ url_for('staff.update_rental_status') }}', {
          method: 'POST',
          body: form
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              document.getElementById('status-' + rentalId).textContent = newStatus;
              var actionButtons = document.getElementById('action-buttons-' + rentalId);
              actionButtons.style.display = (newStatus === 'Completed' ? 'none' : 'block');
              alert('Status updated to ' + newStatus);
          } else {
              throw new Error(data.error || 'Unknown error occurred');
          }
      })
      .catch(error => {
          console.error('Error updating status:', error);
          alert('Failed to update status: ' + error.message);
      });
  }

  function toggleIDVerification(rentalId, isChecked) {
      fetch('{{ url_for('staff.verify_id') }}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `rental_id=${rentalId}&id_verified=${isChecked}`
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // Alert message for success
              alert('ID verification status updated successfully.');
              
              // Update button visibility based on the verification status
              var checkButton = document.getElementById('btn-check-' + rentalId);
              var uncheckButton = document.getElementById('btn-uncheck-' + rentalId);
              if (isChecked) {
                  checkButton.style.display = 'none';
                  uncheckButton.style.display = 'block';
              } else {
                  checkButton.style.display = 'block';
                  uncheckButton.style.display = 'none';
              }
          } else {
              throw new Error(data.message || 'An unknown error occurred.');
          }
      })
      .catch(error => {
          console.error('Error verifying ID:', error);
          alert('Failed to verify ID: ' + error.message);
      });
  }
</script>

{% endblock %}
